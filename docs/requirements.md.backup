# 要件定義書

**作成日**: 2025-11-05  
**最終更新**: 2025-11-05  
**バージョン**: 1.1  
**プロジェクト**: 自動組立ロボットシステム

---

## 1. プロジェクト概要

### 1.1 目的
積層型3Dプリンター、ディスペンサー、XYZ直交ロボットを組み合わせた医療機器の自動組立システムを構築する。

### 1.2 スコープ
- 3Dプリンター制御システム
- ディスペンサー制御システム
- ロボットアーム制御システム
- グリッパー制御システム
- カメラ・画像処理システム
- 統合Webアプリケーション

---

## 2. 機能要件

### 2.1 カメラ制御機能

#### FR-CAM-001: カメラキャプチャ
- **優先度**: 高
- **状態**: ✅ 実装済み
- **内容**: OpenCV経由でUSBカメラから映像を取得する
- **入力**: デバイスID、解像度、FPS
- **出力**: 映像フレーム（numpy配列）
- **実装**: `web_app/main_webrtc_fixed.py`

#### FR-CAM-002: WebRTCストリーミング
- **優先度**: 高
- **状態**: ✅ 実装済み
- **内容**: ブラウザでリアルタイム映像を表示する（低遅延）
- **技術**: aiortc、FastAPI、shared_frameパターン
- **実装**: `web_app/main_webrtc_fixed.py`、`web_app/templates/index_webrtc_fixed.html`
- **備考**: camera_controllerアーキテクチャを採用、transceiver direction=sendonlyで映像送信

#### FR-CAM-003: スナップショット撮影
- **優先度**: 中
- **状態**: ✅ 実装済み
- **内容**: 現在のフレームを画像ファイルとして保存、一覧表示、ダウンロード
- **出力形式**: JPEG
- **API**: POST `/api/camera/snapshot`, GET `/api/camera/snapshots`, GET `/api/camera/snapshot/{filename}`

#### FR-CAM-004: カメラ設定変更
- **優先度**: 中
- **状態**: ✅ 実装済み
- **内容**: 明るさ、コントラスト、彩度、色相、解像度、コーデックを調整
- **インターフェース**: Web UI（カメラパラメータパネル）
- **API**: GET `/api/camera/controls`, POST `/api/camera/control/{name}/{value}`, POST `/api/camera/resolution`, POST `/api/camera/codec`
- **対応コーデック**: MJPEG、YUYV

#### FR-CAM-005: 物体検出
- **優先度**: 高
- **状態**: ❌ 未実装
- **内容**: 色ベースまたはテンプレートマッチングで部品を検出
- **出力**: 検出物体の座標、面積、回転角度

#### FR-CAM-006: 座標キャリブレーション
- **優先度**: 高
- **状態**: ❌ 未実装
- **内容**: カメラ座標とロボット座標のマッピング
- **手順**: 既知位置の物体を複数点撮影し、変換行列を計算

---

### 2.2 グリッパー制御機能

#### FR-GRIP-001: サーボON/OFF
- **優先度**: 高
- **状態**: ✅ 実装済み
- **内容**: Modbus経由でサーボモーターを制御
- **API**: POST `/api/gripper/servo/{action}` (action: on/off)

#### FR-GRIP-002: 原点復帰
- **優先度**: 高
- **状態**: ✅ 実装済み
- **内容**: グリッパーを原点位置に移動
- **API**: POST `/api/gripper/home`

#### FR-GRIP-003: 位置決め動作
- **優先度**: 高
- **状態**: ✅ 実装済み
- **内容**: 指定位置番号へ移動（把持/開放）
- **API**: POST `/api/gripper/move/{position}` (position: 0-63)

#### FR-GRIP-004: 状態モニタリング
- **優先度**: 中
- **状態**: ✅ 実装済み
- **内容**: 現在位置、サーボ状態、アラーム情報を取得
- **API**: GET `/api/gripper/status`
- **更新頻度**: Web UIで2秒ごとに自動更新

#### FR-GRIP-005: ポジションテーブル管理
- **優先度**: 高
- **状態**: ✅ 実装済み
- **内容**: 64個のポジション（0-63）に7つのパラメータを保存・読み込み
- **パラメータ**: 目標位置、位置決め速度、移動力、把持速度、把持力、把持幅、エリア1
- **API**: GET `/api/gripper/position_table/{position}`, POST `/api/gripper/position_table/{position}`
- **UI機能**:
  - 個別編集モード: ポジション選択→読み込み→編集→保存
  - 一覧表示モード: 全64ポジションをテーブル形式で表示（10件/ページ、ページネーション付き）
  - 表示切替ボタンで2つのモードを切り替え可能

#### FR-GRIP-006: 高レベルAPI
- **優先度**: 中
- **状態**: ❌ 未実装
- **内容**: `grip()`, `release()` などの直感的なメソッド

---

### 2.3 3Dプリンター制御機能

#### FR-PRINT-001: 接続確認
- **優先度**: 高
- **状態**: ❌ 未実装
- **内容**: OctoPrintサーバーへの接続状態を確認

#### FR-PRINT-002: 状態取得
- **優先度**: 高
- **状態**: ❌ 未実装
- **内容**: プリンター状態（温度、進捗率など）を取得

#### FR-PRINT-003: プリント開始
- **優先度**: 高
- **状態**: ❌ 未実装
- **内容**: 指定Gコードファイルでプリントを開始

#### FR-PRINT-004: プリント停止・一時停止
- **優先度**: 中
- **状態**: ❌ 未実装
- **内容**: 実行中のプリントを制御

#### FR-PRINT-005: 温度制御
- **優先度**: 高
- **状態**: ❌ 未実装
- **内容**: ノズル・ベッド温度を設定

#### FR-PRINT-006: Gコード送信
- **優先度**: 中
- **状態**: ❌ 未実装
- **内容**: 任意のGコードコマンドを送信

#### FR-PRINT-007: ファイルアップロード
- **優先度**: 低
- **状態**: ❌ 未実装
- **内容**: Gコードファイルをアップロード

---

### 2.4 ディスペンサー制御機能

#### FR-DISP-001: 初期化
- **優先度**: 高
- **状態**: ❌ 未実装
- **内容**: GPIOピンを初期化

#### FR-DISP-002: 吐出制御
- **優先度**: 高
- **状態**: ❌ 未実装
- **内容**: 指定時間だけ接着剤を吐出

#### FR-DISP-003: パルス吐出
- **優先度**: 中
- **状態**: ❌ 未実装
- **内容**: パルス動作で精密な量を吐出

#### FR-DISP-004: 状態監視
- **優先度**: 低
- **状態**: ❌ 未実装
- **内容**: 吐出回数、最終吐出時刻などを記録

---

### 2.5 ロボットアーム制御機能

#### FR-ROBOT-001: 接続・初期化
- **優先度**: 高
- **状態**: ⚠️ 企業ライブラリ確認待ち
- **内容**: ロボットコントローラーへ接続

#### FR-ROBOT-002: 原点復帰
- **優先度**: 高
- **状態**: ⚠️ 企業ライブラリ確認待ち
- **内容**: 全軸を原点位置に移動

#### FR-ROBOT-003: 絶対座標移動
- **優先度**: 高
- **状態**: ⚠️ 企業ライブラリ確認待ち
- **内容**: 指定絶対座標へ移動

#### FR-ROBOT-004: 相対移動
- **優先度**: 中
- **状態**: ⚠️ 企業ライブラリ確認待ち
- **内容**: 現在位置から相対的に移動

#### FR-ROBOT-005: 現在位置取得
- **優先度**: 高
- **状態**: ⚠️ 企業ライブラリ確認待ち
- **内容**: 各軸の現在位置を取得

#### FR-ROBOT-006: 速度・加速度設定
- **優先度**: 中
- **状態**: ⚠️ 企業ライブラリ確認待ち
- **内容**: 移動速度と加速度を設定

#### FR-ROBOT-007: 座標変換
- **優先度**: 高
- **状態**: ❌ 未実装
- **内容**: カメラ座標をロボット座標に変換

---

### 2.6 統合制御機能

#### FR-CTRL-001: デバイス初期化
- **優先度**: 高
- **状態**: ❌ 未実装
- **内容**: 全デバイスを初期化し、接続確認

#### FR-CTRL-002: シーケンス実行
- **優先度**: 高
- **状態**: ❌ 未実装
- **内容**: YAMLで定義された組立シーケンスを実行

#### FR-CTRL-003: エラーハンドリング
- **優先度**: 高
- **状態**: ❌ 未実装
- **内容**: デバイスエラー発生時の回復処理

#### FR-CTRL-004: リトライ機構
- **優先度**: 中
- **状態**: ❌ 未実装
- **内容**: 失敗したタスクを自動リトライ

#### FR-CTRL-005: ログ記録
- **優先度**: 中
- **状態**: ❌ 未実装
- **内容**: 全タスクの実行履歴をログファイルに記録

#### FR-CTRL-006: 状態監視
- **優先度**: 高
- **状態**: ❌ 未実装
- **内容**: 全デバイスの状態をリアルタイムで取得

---

### 2.7 Webアプリケーション機能

#### FR-WEB-001: ダッシュボード
- **優先度**: 高
- **状態**: ❌ 未実装
- **内容**: 全デバイスの状態を一覧表示

#### FR-WEB-002: カメラビュー
- **優先度**: 高
- **状態**: ✅ 実装済み
- **内容**: WebRTCでリアルタイム映像を表示、パラメータ調整、スナップショット撮影
- **UI構成**: 左パネル（70%）にビデオ、右パネル（30%）に制御パネル
- **パネル**: カメラパラメータ、スナップショット、グリッパー制御、ポジションテーブル（折りたたみ可能）

#### FR-WEB-003: 手動操作パネル
- **優先度**: 中
- **状態**: ⚠️ 部分実装（グリッパーのみ）
- **内容**: グリッパーの手動操作（サーボON/OFF、原点復帰、位置移動）が可能
- **未実装**: ロボットアーム、3Dプリンター、ディスペンサーの操作パネル

#### FR-WEB-004: シーケンス管理
- **優先度**: 高
- **状態**: ❌ 未実装
- **内容**: シーケンスの作成、編集、実行

#### FR-WEB-005: ログビューアー
- **優先度**: 低
- **状態**: ❌ 未実装
- **内容**: 実行ログをWeb上で閲覧

#### FR-WEB-006: 設定画面
- **優先度**: 中
- **状態**: ❌ 未実装
- **内容**: システム設定の変更

#### FR-WEB-007: WebSocket通信
- **優先度**: 高
- **状態**: ❌ 未実装
- **内容**: リアルタイム状態更新

---

## 3. 非機能要件

### 3.1 性能要件

#### NFR-PERF-001: カメラフレームレート
- **要件**: 最低20 FPS以上でストリーミング
- **測定**: WebRTCストリーム表示時のFPS
- **状態**: ✅ 達成（640x480@30fps で安定動作）

#### NFR-PERF-002: 応答時間
- **要件**: デバイスコマンド送信から応答まで1秒以内
- **例外**: 移動完了待ちなど時間のかかる動作は除く
- **状態**: ✅ 達成（グリッパー制御で確認）

#### NFR-PERF-003: 同時接続
- **要件**: Web UIに最低2台のブラウザから同時接続可能
- **状態**: ⚠️ 未検証

---

### 3.2 信頼性要件

#### NFR-REL-001: エラー回復
- **要件**: デバイス通信エラー発生時、自動で再接続を試みる
- **リトライ**: 最大3回まで
- **状態**: ❌ 未実装

#### NFR-REL-002: ログ保存
- **要件**: すべてのエラーとタスク実行履歴をログファイルに記録
- **保存期間**: 最低30日間
- **状態**: ⚠️ 部分実装（サーバーログのみ、/tmp/webrtc_running.log）

#### NFR-REL-003: 状態保存
- **要件**: システム再起動時、前回の設定を復元
- **状態**: ❌ 未実装

---

### 3.3 保守性要件

#### NFR-MAIN-001: モジュール独立性
- **要件**: 各デバイスコントローラーは独立して動作可能
- **理由**: テスト・デバッグの容易性
- **状態**: ✅ 達成（gripper_controller、web_appは独立動作可能）

#### NFR-MAIN-002: 設定ファイル
- **要件**: ハードコードせず、YAMLファイルで設定管理
- **場所**: `config/system_config.yaml`
- **状態**: ❌ 未実装

#### NFR-MAIN-003: ドキュメント
- **要件**: 各モジュールにREADME.mdを添付
- **内容**: 使用方法、API仕様、サンプルコード
- **状態**: ⚠️ 部分実装（requirements.md、schema.md、device_specifications.mdは存在）

---

### 3.4 セキュリティ要件

#### NFR-SEC-001: API認証
- **要件**: OctoPrint APIキーは環境変数で管理
- **禁止**: APIキーのハードコードやGitコミット
- **状態**: ❌ 未実装

#### NFR-SEC-002: アクセス制限
- **要件**: Webアプリケーションへのアクセスをローカルネットワークに制限
- **方法**: ファイアウォール設定
- **状態**: ⚠️ 部分実装（デフォルトでlocalhost:8000、ローカルネットワークからアクセス可能）

---

### 3.5 互換性要件

#### NFR-COMP-001: Python環境
- **要件**: Python 3.9以上で動作
- **推奨**: Python 3.11
- **状態**: ✅ 確認済み（Python 3.11.2で動作）

#### NFR-COMP-002: OS
- **要件**: Raspberry Pi OS (Debian系) で動作
- **テスト**: Raspberry Pi 4 Model B 以上
- **状態**: ✅ 確認済み（Raspberry Pi OS 11 Bullseye）

#### NFR-COMP-003: ブラウザ
- **要件**: Chrome、Firefox、Edge の最新版で動作
- **状態**: ✅ 確認済み（WebRTC動作確認済み）

---

## 4. 制約事項

### 4.1 ハードウェア制約
- Raspberry Pi のGPIO電圧は3.3V
- グリッパーはModbus RTU通信のみ対応
- カメラはUSB接続またはCSI接続
- 現在のシステム構成:
  - カメラ: C922 Pro Stream Webcam (最大2304x1536)
  - グリッパー: IAI RCP2-GRSS (PCON-CB) @ 38400 baud

### 4.2 ソフトウェア制約
- PythonのGILによる並行処理の制限 → asyncioで対応
- WebRTCはHTTPSまたはlocalhostでのみ動作 → 現在localhostで運用

### 4.3 外部依存
- OctoPrintサーバーが稼働していること（未接続）
- 企業提供のロボット制御ライブラリが必要（未提供）

---

## 5. 現在の実装状況（2025-11-05時点）

### 実装完了済み
- ✅ WebRTCカメラストリーミング（shared_frameパターン）
- ✅ カメラパラメータ調整（明るさ、コントラスト、彩度等）
- ✅ 解像度変更（QVGA～Full HD）
- ✅ コーデック切替（MJPEG/YUYV）
- ✅ スナップショット撮影・一覧表示・ダウンロード
- ✅ グリッパー制御（サーボON/OFF、原点復帰、位置移動）
- ✅ グリッパー状態監視（位置、サーボ状態）
- ✅ ポジションテーブル管理（64ポジション×7パラメータ）
  - 個別編集モード
  - 一覧表示モード（10件/ページ）
- ✅ Web UI（左右パネル構成、折りたたみパネル）

### 未実装・今後の課題
- ❌ 3Dプリンター制御（OctoPrint連携）
- ❌ ディスペンサー制御
- ❌ ロボットアーム制御（企業ライブラリ待ち）
- ❌ 物体検出・座標変換
- ❌ 統合シーケンス実行エンジン
- ❌ WebSocket通信（リアルタイム更新）
- ❌ 設定ファイル管理（YAML）
- ❌ ログビューアー

---

## 6. アクセス情報

- **Web UI**: http://10.32.77.150:8000
- **サーバー**: nohup background process
- **ログ**: /tmp/webrtc_running.log
- **スナップショット保存先**: web_app/snapshots/

---

**作成者**: GitHub Copilot  
**最終更新者**: GitHub Copilot  
**レビュー**: 未  
**承認**: 未
