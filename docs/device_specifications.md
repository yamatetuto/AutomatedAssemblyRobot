# デバイス仕様書

本ドキュメントは、自動組立ロボットシステムで使用する各デバイスの技術仕様をまとめたものです。

---

## 1. USBカメラ

### 基本情報
- **デバイスパス**: `/dev/video0`
- **接続方式**: USB 2.0/3.0
- **ドライバ**: V4L2 (Video4Linux2)

### サポートフォーマット
- **ピクセルフォーマット**: YUYV 4:2:2
- **最大解像度**: 2304x1536 (約350万画素)

### 対応解像度とフレームレート
| 解像度 | 最大FPS | 推奨FPS | 用途 |
|--------|---------|---------|------|
| 2304x1536 | 2 fps | 2 fps | 高解像度静止画 |
| 1920x1080 | 5 fps | 5 fps | Full HD撮影 |
| 1280x720 | 10 fps | 10 fps | HD撮影 |
| 640x480 | 30 fps | 24-30 fps | リアルタイム監視 |
| 320x240 | 30 fps | 30 fps | 低遅延監視 |

### 制御可能パラメータ

#### User Controls
| パラメータ | 最小値 | 最大値 | ステップ | デフォルト | 説明 |
|-----------|--------|--------|----------|-----------|------|
| brightness | 0 | 255 | 1 | 128 | 明るさ調整 |
| contrast | 0 | 255 | 1 | 128 | コントラスト |
| saturation | 0 | 255 | 1 | 128 | 彩度 |
| gain | 0 | 255 | 1 | 0 | ゲイン（増幅率） |
| sharpness | 0 | 255 | 1 | 128 | シャープネス |
| backlight_compensation | 0 | 1 | 1 | 0 | 逆光補正 |
| white_balance_automatic | false | true | - | true | 自動ホワイトバランス |
| white_balance_temperature | 2000 | 6500 | 1 | 4000 | 色温度 (K) |
| power_line_frequency | 0-2 | - | - | 2 | 電源周波数 (0:無効, 1:50Hz, 2:60Hz) |

#### Camera Controls
| パラメータ | 最小値 | 最大値 | ステップ | デフォルト | 説明 |
|-----------|--------|--------|----------|-----------|------|
| auto_exposure | 0 | 3 | 1 | 3 | 露出モード (0:Manual, 3:Aperture Priority) |
| exposure_time_absolute | 3 | 2047 | 1 | 250 | 露出時間 (100μs単位) |
| exposure_dynamic_framerate | false | true | - | false | 動的フレームレート調整 |
| pan_absolute | -36000 | 36000 | 3600 | 0 | パン角度 (0.001度単位) |
| tilt_absolute | -36000 | 36000 | 3600 | 0 | チルト角度 (0.001度単位) |
| focus_absolute | 0 | 250 | 5 | 0 | フォーカス位置 |
| focus_automatic_continuous | false | true | - | true | 連続オートフォーカス |
| zoom_absolute | 100 | 500 | 1 | 100 | ズーム倍率 (%) |

### 推奨設定値

#### 高精度検査用
```yaml
resolution: 2304x1536
fps: 2
brightness: 128
contrast: 140
sharpness: 160
auto_exposure: Manual
exposure_time_absolute: 500
```

#### リアルタイムモニタリング用
```yaml
resolution: 640x480
fps: 30
brightness: 128
contrast: 128
sharpness: 128
auto_exposure: Aperture Priority
focus_automatic_continuous: true
```

#### WebRTC配信用 (低遅延)
```yaml
resolution: 640x480 または 1280x720
fps: 24-30
brightness: 140
contrast: 128
exposure_time_absolute: 250
```

---

## 2. IAI 電動グリッパ (RCP2-GRSS) + PCONコントローラー

### 基本情報

#### グリッパー本体
- **型番**: RCP2-GRSS-8-I-20P-30-P3
- **メーカー**: IAI (アイエイアイ)
- **タイプ**: 2ツ爪パラレルグリッパー
- **モーター**: パルスモーター (20□サイズ、減速比1/30)
- **エンコーダー**: インクリメンタル (800 pulse/rev)

#### PCONコントローラー (PCON-CB)
- **型番**: PCON-CB (PCON-CBシリーズ)
- **通信方式**: Modbus RTU (RS-485)
- **接続**: USB経由でRaspberry Piと接続
  - USB-RS485変換アダプタ経由でRS-485通信
- **デバイスパス**: `/dev/ttyUSB0`
- **通信仕様**:
  - **ボーレート**: 9600, 14400, 19200, 28800, **38400**, 57600, 76800, 115200, 230400 bps (選択可能)
  - **現在の設定**: 38400 bps
  - **スレーブアドレス**: 1 (軸番号、1-16で設定可能)
  - **データビット**: 8
  - **パリティ**: None
  - **ストップビット**: 1
  - **タイムアウト**: 0.5秒

⚠️ **重要**: コントローラーはブレーク信号を検出すると自動的に9600bpsに切り替わる仕様のため、シリアル接続時には注意が必要

### 動作仕様

| 項目 | 仕様値 | 備考 |
|------|--------|------|
| **ストローク (片側)** | 0 ~ 4 mm | 最大ストローク8mm (両側合計) |
| **把持力 (両側)** | 最大 14 N | - |
| **垂直方向許容荷重** | 60 N | - |
| **繰り返し位置決め精度** | ±0.01 mm | - |
| **バックラッシ** | 片側 0.2 mm 以下 | スプリングにより常時開側に加圧 |
| **ロストモーション** | 片側 0.05 mm 以下 | - |
| **把持動作時最高速度 (片側)** | 5 mm/s | 把持動作専用 |
| **アプローチ動作最高速度 (片側)** | 78 mm/s | 位置決め移動時 |
| **最低速度 (片側)** | 5 mm/s | - |
| **定格加減速度 (片側)** | 0.3 G | - |
| **最高加減速度 (片側)** | 0.3 G | - |
| **ポジション数** | 0 ~ 99 | 100個のティーチング位置 |
| **原点復帰時間** | 約2秒 | 初期化時に必須 |
| **位置決め完了時間** | 0.5 ~ 3秒 | 移動距離による |

### 駆動仕様
- **駆動方式**: ウォームギヤ + はすばギヤ + はすばラック
- **リニアガイド**: 有限ガイド
- **ボールねじリード**: 1.57 mm相当
- **静的許容モーメント**:
  - Ma: 0.5 N·m
  - Mb: 0.5 N·m  
  - Mc: 1.5 N·m

### 環境仕様
- **使用周囲温度**: 0 ~ 40°C
- **使用周囲湿度**: 85% RH以下 (結露なきこと)
- **保護等級**: IP20相当
- **耐振動・耐衝撃**: 4.9 m/s²
- **対応規格**: CEマーク、RoHS指令

### Modbusレジスタマップ

#### 制御レジスタ (書き込み)
| アドレス | 名称 | 説明 |
|----------|------|------|
| 0x0D00 | デバイス制御レジスタ1 (DRG1) | サーボON/OFF、起動制御 |
| 0x0D03 | ポジション番号指定 (POSR) | 移動先ポジション (0-99) |
| 0x1000~ | ポジションテーブル | 各ポジションの座標値 (0.01mm単位) |

#### ステータスレジスタ (読み取り)
| アドレス | 名称 | 説明 |
|----------|------|------|
| 0x9000 | 現在位置 (PNOW) | 現在の位置 (0.01mm単位、片側) |
| 0x9002 | アラームコード (ALMC) | 発生中のアラーム |
| 0x9005 | デバイスステータス1 (DSS1) | サーボ状態、動作完了フラグ |
| 0x9007 | 拡張ステータス (DSSE) | 移動中信号など |
| 0x900C | 電流値モニター (CNOW) | モーター電流 |
| 0x901E | 荷重データ (FBFC) | ロードセル値 |

#### 制御ビット (0x0D00)
| ビット | 値 | 機能 |
|--------|-----|------|
| 12 | 0x1000 | サーボON |
| 4 | 0x0010 | 原点復帰 |
| 3 | 0x0008 | 位置決め起動 |

**制御コマンド例**:
- サーボON: `0x1000`
- 原点復帰: `0x1010` (サーボON + 原点復帰)
- 位置決め: `0x1008` (サーボON + 起動)

#### ステータスビット (0x9005)
| ビット | 名称 | 説明 |
|--------|------|------|
| 12 | SV | サーボON状態 (1=ON) |
| 11 | PSFL | 押付け空振りフラグ |
| 4 | HEND | 原点復帰完了 (1=完了) |
| 3 | PEND | 位置決め完了 (1=完了) |

#### 拡張ステータスビット (0x9007)
| ビット | 名称 | 説明 |
|--------|------|------|
| 5 | MOVE | 移動中信号 (1=移動中) |

### アラームコード
| コード | 内容 | 対処方法 |
|--------|------|----------|
| 0x0000 | 正常 | - |
| 0x0010 | サーボアラーム | サーボOFF→ONで復帰 |
| 0x0020 | 過負荷 | 把持物を確認、負荷を軽減 |
| 0x0040 | 位置決めエラー | 原点復帰を実行 |
| 0x0100 | 通信エラー | 配線確認、再接続 |

### 動作制約・注意事項

#### ⚠️ 安全制約
1. **サーボON必須**: 動作前に必ずサーボONすること
2. **原点復帰**: 初回起動時および位置ずれ時は原点復帰を実行
3. **移動完了待機**: 次の動作前に移動完了を確認 (MOVE=0)
4. **過負荷防止**: 把持力を監視し、異常時は即停止
5. **ストローク制限**: 片側0~4mm範囲外への移動禁止 (両側合計8mm)
6. **速度制限**: 
   - 把持動作: 最大5mm/s
   - アプローチ動作: 最大78mm/s
7. **バックラッシ考慮**: 片側0.2mm以下のバックラッシあり

#### 推奨動作シーケンス
```
1. サーボON (0x1000) → SV=1を確認 (タイムアウト: 3秒)
2. 原点復帰 (0x1010) → HEND=1を待機 (タイムアウト: 15秒)
3. ポジション指定 (0x0D03に0-99を書込)
4. 位置決め起動 (0x1008)
5. 移動完了待機 (MOVE=0 & PEND=1を確認) (タイムアウト: 10秒)
6. 次動作へ
```

#### タイムアウト設定
| 動作 | 推奨タイムアウト | 理由 |
|------|------------------|------|
| サーボON確認 | 3秒 | 即座に応答 |
| 原点復帰 | 15秒 | 最大ストローク移動 + 余裕 |
| 位置決め (短距離) | 5秒 | 1mm移動時 |
| 位置決め (長距離) | 10秒 | 4mm移動時 |
| 移動停止確認 | 10秒 | 安全マージン |

#### 通信に関する注意
1. **ブレーク信号**: USB接続時のブレーク信号により、ボーレートが9600bpsに自動変更される可能性あり
2. **初期化**: 電源投入後、必ずボーレート設定を確認
3. **Modbus RTUモード**: 最大256バイトのデータ転送が可能
4. **マルチスレーブ**: 最大16軸まで接続可能 (SIOリンクシステム使用時)

### 座標系
- **原点**: グリッパー完全開放位置
- **単位**: 0.01mm (レジスタ値1 = 0.01mm)
- **範囲**: 0 ~ 400 (0.00mm ~ 4.00mm、片側)
- **両側合計**: 0 ~ 8mm

### ポジションデータ
- **記憶数**: 100個 (ポジション番号0~99)
- **記憶方法**: ティーチングまたはダイレクト入力
- **データ形式**: 0.01mm単位の整数値
- **揮発性**: 不揮発性メモリに保存


---

## 3. Tronxy GEMINI S 3Dプリンター

### 基本情報
- **型番**: GEMINI S
- **メーカー**: Tronxy
- **制御方式**: OctoPrint API経由
- **ファームウェア**: Marlin互換
- **接続**: USB経由でRaspberry Piに接続

### 造形仕様
| 項目 | 仕様値 |
|------|--------|
| 造形方式 | FDM (熱溶解積層方式) |
| 造形サイズ | 255mm × 255mm × 300mm |
| ノズル径 | 0.4mm (標準) |
| 積層ピッチ | 0.05 ~ 0.3mm |
| 最大造形速度 | 150 mm/s |
| フィラメント径 | 1.75mm |

### OctoPrint API制御
- **APIエンドポイント**: `http://localhost:5000/api`
- **認証**: API Keyによる認証
- **主要機能**: 
  - プリント開始/停止/一時停止
  - 温度制御 (ノズル、ベッド)
  - ファイルアップロード
  - プリント進捗監視

### 接続情報
```yaml
host: localhost または octopi.local
port: 5000
api_key: 環境変数 OCTOPRINT_API_KEY より取得
serial_port: /dev/ttyUSB1 (プリンター接続)
baudrate: 115200
```

---

## 4. XYZ直交ロボット (自動組立装置)

### 基本情報
- **製造**: 株式会社コスモスウェブ
- **制御**: 専用Pythonライブラリ (既存)
- **ライブラリパス**: `robot_controller/` (統合予定)

### 動作範囲
| 軸 | 装置サイズ | ストローク |
|----|-----------|-----------|
| X軸 | 1200 mm | 800 mm |
| Y軸 | 850 mm | 250 mm |
| Z軸 | 750 mm | 100 mm |

### 位置決め精度
- **繰り返し精度**: ±0.1 mm
- **絶対精度**: ±0.5 mm

### 動作速度
- **最大速度**: 200 mm/s (軸による)
- **推奨速度**: 50-100 mm/s
- **加減速**: トラペゾイド制御

### 座標系
- **原点**: 装置の左奥下端
- **座標系**: 右手系 (X:右, Y:手前, Z:上)

---

## 5. ディスペンサー

### 基本情報
- **制御方式**: GPIO制御
- **接続**: Raspberry PiのGPIOピン
- **動作**: ON/OFF制御

### 制御仕様
| 項目 | 仕様値 |
|------|--------|
| 制御電圧 | 3.3V または 5V |
| 制御信号 | デジタルON/OFF |
| 最小パルス幅 | 50ms |
| 吐出量制御 | パルス幅による調整 |

### GPIO割り当て (予定)
```yaml
dispenser_control_pin: GPIO17  # 吐出制御
dispenser_enable_pin: GPIO27   # 有効化信号
```

---

## 6. Raspberry Pi

### ハードウェア構成
- **モデル**: Raspberry Pi 4 Model B (推奨) または Raspberry Pi 3
- **メモリ**: 4GB以上推奨
- **OS**: Raspberry Pi OS (Debian 11 Bullseye base)
- **Python**: 3.11

### 接続デバイス
| デバイス | インターフェース | ポート/ピン |
|---------|-----------------|-----------|
| USBカメラ | USB 2.0/3.0 | `/dev/video0` |
| グリッパー | USB-RS485変換 | `/dev/ttyUSB0` |
| 3Dプリンター | USB | `/dev/ttyUSB1` |
| ディスペンサー | GPIO | GPIO17, GPIO27 |
| XYZロボット | イーサネット | LAN経由 |

### システムリソース推奨値
```yaml
CPU使用率: < 70%
メモリ使用: < 3GB
ストレージ: 16GB以上 (32GB推奨)
ネットワーク: 有線LAN推奨 (低遅延)
```

---

## 7. 統合システム要件

### リアルタイム性
| 機能 | 目標レイテンシ | 備考 |
|------|---------------|------|
| カメラストリーミング | < 100ms | WebRTC使用 |
| グリッパー応答 | < 50ms | Modbus RTU |
| ロボット位置更新 | < 20ms | 専用ライブラリ |
| 画像処理 | < 500ms | OpenCV |

### 同時動作制約
- カメラストリーミング + グリッパー制御: 可能
- 3Dプリント中 + ロボット動作: 不可 (干渉防止)
- 画像処理中の高速動作: 注意 (CPU負荷)

---

## 8. ネットワーク構成

### IPアドレス構成 (例)
```
Raspberry Pi (メイン): 192.168.1.100
Raspberry Pi (カメラ専用): 192.168.1.101
XYZロボットコントローラ: 192.168.1.50
クライアントPC: 192.168.1.10
```

### ポート割り当て
```
8000: FastAPI Web UI
5000: OctoPrint
8080: WebRTC Signaling
3478/3479: STUN/TURN
```

---

## 改訂履歴
| 日付 | バージョン | 内容 | 作成者 |
|------|-----------|------|--------|
| 2025-11-05 | 1.0 | 初版作成 | GitHub Copilot |
| 2025-11-05 | 1.1 | グリッパー仕様を詳細化 (RCP2-GRSS+PCON-CB) | GitHub Copilot |

