# Camera Module

OpenCV + V4L2 ã‚«ãƒ¡ãƒ©åˆ¶å¾¡ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

## æ¦‚è¦

ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã€USB Webã‚«ãƒ¡ãƒ©ï¼ˆLogitech C922 Proç­‰ï¼‰ã‚’OpenCV + V4L2ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§åˆ¶å¾¡ã—ã€WebRTCã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ç”¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æä¾›ã—ã¾ã™ã€‚camera_app.py ã¨é€£æºã™ã‚‹ã“ã¨ã§ã€ã‚«ãƒ¡ãƒ©ã‚’åˆ¥Raspberry Piã«åˆ†é›¢ã™ã‚‹é‹ç”¨ã‚‚å¯èƒ½ã§ã™ã€‚

### ä¸»ãªæ©Ÿèƒ½

- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚­ãƒ£ãƒ—ãƒãƒ£**: éåŒæœŸãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ—ã«ã‚ˆã‚‹é€£ç¶šãƒ•ãƒ¬ãƒ¼ãƒ å–å¾—
- **è‡ªå‹•å†æ¥ç¶š**: ã‚«ãƒ¡ãƒ©åˆ‡æ–­æ™‚ã®è‡ªå‹•å¾©æ—§
- **è§£åƒåº¦å¯¾å¿œ**: 320Ã—240 ã€œ 1920Ã—1080ï¼ˆé«˜è§£åƒåº¦æ™‚ã¯FPSè‡ªå‹•èª¿æ•´ï¼‰
- **ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯é¸æŠ**: MJPEG / YUYV å¯¾å¿œ
- **V4L2ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«**: æ˜ã‚‹ã•ã€ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã€éœ²å‡ºã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç­‰ã®å‹•çš„èª¿æ•´
- **ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ**: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãç”»åƒä¿å­˜

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
src/camera/
â”œâ”€â”€ __init__.py       # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–
â”œâ”€â”€ camera_manager.py # ã‚«ãƒ¡ãƒ©ç®¡ç†ã‚¯ãƒ©ã‚¹
â””â”€â”€ README.md         # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬çš„ãªä½¿ã„æ–¹

```python
from src.camera.camera_manager import CameraManager

# åˆæœŸåŒ–ã¨ã‚«ãƒ¡ãƒ©èµ·å‹•
camera = CameraManager()
await camera.start()

# ç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ å–å¾—
frame = camera.get_frame()
if frame is not None:
    print(f"ãƒ•ãƒ¬ãƒ¼ãƒ ã‚µã‚¤ã‚º: {frame.shape}")  # (480, 640, 3)

# ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ’®å½±
result = await camera.take_snapshot()
print(f"ä¿å­˜å…ˆ: {result['path']}")

# ã‚«ãƒ¡ãƒ©åœæ­¢
await camera.stop()
```

### ã‚«ãƒ¡ãƒ©ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®å–å¾—ã¨è¨­å®š

```python
# åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ä¸€è¦§ã‚’å–å¾—
controls = camera.get_controls()
for name, info in controls.items():
    print(f"{name}: {info['value']} (min={info['min']}, max={info['max']})")

# ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å€¤ã‚’è¨­å®š
await camera.set_control("brightness", 128)
await camera.set_control("auto_exposure", 1)  # ãƒãƒ‹ãƒ¥ã‚¢ãƒ«éœ²å‡º

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«ãƒªã‚»ãƒƒãƒˆ
await camera.reset_controls()
```

### è§£åƒåº¦ãƒ»ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯å¤‰æ›´

```python
# è§£åƒåº¦å¤‰æ›´
await camera.set_resolution(1280, 720)

# ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯å¤‰æ›´ (MJPEGæ¨å¥¨)
await camera.set_fourcc("MJPG")
```

## ãƒªãƒ¢ãƒ¼ãƒˆã‚«ãƒ¡ãƒ©é‹ç”¨

- camera_app.py ã‚’ã‚«ãƒ¡ãƒ©å´Piã§èµ·å‹•
- app.py å´ã§ã¯ `CAMERA_REMOTE_BASE_URL` ã‚’æŒ‡å®š

UIä¸Šã§ã¯ã€ŒğŸ“¹ ãƒ­ãƒ¼ã‚«ãƒ«ã‚«ãƒ¡ãƒ©ä½¿ç”¨ä¸­ã€ã€ŒğŸ“¡ ã‚«ãƒ¡ãƒ©Pi: æ¥ç¶šä¸­/æœªæ¥ç¶šã€ã§çŠ¶æ…‹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

## ç”»åƒãƒ‡ãƒ¼ã‚¿ä»•æ§˜

### ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿

- **å½¢å¼**: NumPyé…åˆ— (H, W, C)
- **è§£åƒåº¦**: è¨­å®šã«ã‚ˆã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 640Ã—480ï¼‰
- **ãƒãƒ£ãƒ³ãƒãƒ«**: 3 (BGRé †åº, OpenCVå½¢å¼)
- **ãƒ‡ãƒ¼ã‚¿å‹**: uint8
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ**: è§£åƒåº¦ã«å¿œã˜ã¦è‡ªå‹•èª¿æ•´
  - 640Ã—480: æœ€å¤§30fps
  - 1280Ã—720: æœ€å¤§20fps
  - 1920Ã—1080: æœ€å¤§15fps

### å¯¾å¿œã‚³ãƒ¼ãƒ‡ãƒƒã‚¯

| ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯ | èª¬æ˜ | CPUè² è· |
|-----------|------|---------|
| MJPG | Motion JPEG | ä½ (æ¨å¥¨) |
| YUYV | éåœ§ç¸®YUV | é«˜ |

## V4L2ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ä¸€è¦§

`get_controls()` ã§å–å¾—ã§ãã‚‹ä»£è¡¨çš„ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:

| ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å | å‹ | èª¬æ˜ |
|---------------|-----|------|
| brightness | int | æ˜ã‚‹ã• |
| contrast | int | ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ |
| saturation | int | å½©åº¦ |
| sharpness | int | ã‚·ãƒ£ãƒ¼ãƒ—ãƒã‚¹ |
| gain | int | ã‚²ã‚¤ãƒ³ |
| exposure_auto | menu | éœ²å‡ºãƒ¢ãƒ¼ãƒ‰ (1=Manual, 3=Auto) |
| exposure_absolute | int | éœ²å‡ºæ™‚é–“ (ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æ™‚) |
| focus_auto | bool | ã‚ªãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ |
| focus_absolute | int | ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è·é›¢ |
| white_balance_automatic | bool | è‡ªå‹•ãƒ›ãƒ¯ã‚¤ãƒˆãƒãƒ©ãƒ³ã‚¹ |
| white_balance_temperature | int | è‰²æ¸©åº¦ |
| power_line_frequency | menu | é›»æºå‘¨æ³¢æ•° (0=Off, 1=50Hz, 2=60Hz) |

## API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

### CameraManager ã‚¯ãƒ©ã‚¹

#### ãƒ¡ã‚½ãƒƒãƒ‰

##### `__init__()`
ã‚«ãƒ¡ãƒ©ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚è¨­å®šã¯ `src/config/settings.py` ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã™ã€‚

##### `async start() -> None`
ã‚«ãƒ¡ãƒ©ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’é–‹å§‹ã—ã¾ã™ã€‚ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ã§ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ç¶™ç¶šå–å¾—ã—ã¾ã™ã€‚

##### `async stop() -> None`
ã‚«ãƒ¡ãƒ©ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’åœæ­¢ã—ã€ãƒªã‚½ãƒ¼ã‚¹ã‚’è§£æ”¾ã—ã¾ã™ã€‚

##### `get_frame() -> Optional[np.ndarray]`
æœ€æ–°ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å–å¾—ã—ã¾ã™ã€‚ãƒ•ãƒ¬ãƒ¼ãƒ ãŒãªã„å ´åˆã¯Noneã‚’è¿”ã—ã¾ã™ã€‚

##### `is_opened() -> bool`
ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

##### `async take_snapshot() -> Optional[Dict]`
ç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’JPEGãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚

##### `get_controls() -> Dict`
V4L2ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ä¸€è¦§ã¨ç¾åœ¨å€¤ã‚’å–å¾—ã—ã¾ã™ã€‚

##### `async set_control(name: str, value: int) -> bool`
V4L2ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®å€¤ã‚’è¨­å®šã—ã¾ã™ã€‚

##### `async set_resolution(width: int, height: int) -> bool`
è§£åƒåº¦ã‚’å¤‰æ›´ã—ã¾ã™ï¼ˆã‚«ãƒ¡ãƒ©å†èµ·å‹•ãŒå¿…è¦ï¼‰ã€‚

##### `async set_fourcc(fourcc: str) -> bool`
ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯ã‚’å¤‰æ›´ã—ã¾ã™ï¼ˆ"MJPG" ã¾ãŸã¯ "YUYV"ï¼‰ã€‚

## è¨­å®š

ã‚«ãƒ¡ãƒ©è¨­å®šã¯ `src/config/settings.py` ã§ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã™:

```python
CAMERA_DEVICE = int(os.getenv('CAMERA_DEVICE', '0'))      # /dev/videoç•ªå·
CAMERA_WIDTH = int(os.getenv('CAMERA_WIDTH', '640'))      # å¹…
CAMERA_HEIGHT = int(os.getenv('CAMERA_HEIGHT', '480'))    # é«˜ã•
CAMERA_FPS = int(os.getenv('CAMERA_FPS', '30'))           # ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ
CAMERA_FOURCC = os.getenv('CAMERA_FOURCC', 'MJPG')        # ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯
CAMERA_REMOTE_BASE_URL = os.getenv('CAMERA_REMOTE_BASE_URL', '').rstrip('/')
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### "ã‚«ãƒ¡ãƒ©ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ"

**åŸå› **: ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯æ¨©é™ä¸è¶³

**å¯¾ç­–**:
1. ã‚«ãƒ¡ãƒ©æ¥ç¶šã‚’ç¢ºèª: `v4l2-ctl --list-devices`
2. æ¨©é™ã‚’è¨­å®š: `sudo usermod -a -G video $USER`
3. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ»ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦æ¨©é™ã‚’åæ˜ 

### ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆãŒä½ã„

**åŸå› **: é«˜è§£åƒåº¦è¨­å®šã€YUYVä½¿ç”¨ã€CPUè² è·

**å¯¾ç­–**:
1. MJPEGã‚³ãƒ¼ãƒ‡ãƒƒã‚¯ã‚’ä½¿ç”¨
2. è§£åƒåº¦ã‚’ä¸‹ã’ã‚‹
3. ä¸è¦ãªãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢

### ç”»åƒãŒæš—ã„ / ãƒ›ãƒ¯ã‚¤ãƒˆãƒãƒ©ãƒ³ã‚¹ãŒãŠã‹ã—ã„

**å¯¾ç­–**:
1. Web UIã§ã‚«ãƒ¡ãƒ©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´
2. ã‚ªãƒ¼ãƒˆè¨­å®šã‚’ON/OFFã§åˆ‡ã‚Šæ›¿ãˆã‚‹
3. `v4l2-ctl` ã§ç›´æ¥è¨­å®šã‚’ç¢ºèª

## ä¾å­˜é–¢ä¿‚

- **opencv-python**: ã‚«ãƒ¡ãƒ©ã‚­ãƒ£ãƒ—ãƒãƒ£ã¨ç”»åƒå‡¦ç†
- **v4l-utils**: V4L2ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ“ä½œï¼ˆã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼‰
- **asyncio**: éåŒæœŸå‡¦ç†

---

**æœ€çµ‚æ›´æ–°**: 2026-01-06

### æ©Ÿèƒ½

#### å‹•çš„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ¤œå‡º
```python
controls = camera_manager.get_controls()
# {
#   "brightness": {"type": "int", "min": 0, "max": 255, "default": 128, ...},
#   "exposure_auto": {"type": "menu", "options": [{"value": 0, "name": "Auto"}, ...]}
# }
```

#### ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¨­å®š
```python
# æ•´æ•°å€¤
camera_manager.set_control("brightness", 200)

# ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆå€¤ã§æŒ‡å®šï¼‰
camera_manager.set_control("exposure_auto", 1)

# ãƒ–ãƒ¼ãƒ«å€¤
camera_manager.set_control("auto_white_balance", 0)
```

#### ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®å­˜åœ¨ç¢ºèª
- ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯ï¼ˆinactive/disabled/grabbedï¼‰
- å€¤ã®ç¯„å›²æ¤œè¨¼ï¼ˆmin/maxï¼‰
- èª­ã¿å–ã‚Šå°‚ç”¨ãƒã‚§ãƒƒã‚¯

#### ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
```python
# å€‹åˆ¥ãƒªã‚»ãƒƒãƒˆ
camera_manager.reset_control("brightness")

# ä¸€æ‹¬ãƒªã‚»ãƒƒãƒˆï¼ˆinactive/disabled/buttonã¯è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—ï¼‰
results = camera_manager.reset_all_controls()
# {"brightness": True, "contrast": True, "reset_button": False, ...}
```

### API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- `GET /api/camera/controls`: å…¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å–å¾—
- `POST /api/camera/control/{name}/{value}`: ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¨­å®š
- `POST /api/camera/control/reset/{name}`: å€‹åˆ¥ãƒªã‚»ãƒƒãƒˆ
- `POST /api/camera/controls/reset_all`: ä¸€æ‹¬ãƒªã‚»ãƒƒãƒˆ

### å¯¾å¿œã‚«ãƒ¡ãƒ©ä¾‹
- Raspberry Pi Camera Module (v1/v2/v3)
- USB Webã‚«ãƒ¡ãƒ©ï¼ˆUVCå¯¾å¿œï¼‰
- ç”£æ¥­ç”¨ã‚«ãƒ¡ãƒ©ï¼ˆv4l2å¯¾å¿œï¼‰
