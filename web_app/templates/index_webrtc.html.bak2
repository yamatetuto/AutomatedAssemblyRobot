<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå‹•çµ„ç«‹ãƒ­ãƒœãƒƒãƒˆåˆ¶å¾¡ - WebRTCç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        h1 { font-size: 2.5em; margin-bottom: 10px; }
        .subtitle { opacity: 0.9; font-size: 1.1em; }
        
        .content { padding: 30px; }
        .panel {
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        .panel-header:hover { opacity: 0.9; }
        .panel-header h2 { font-size: 1.3em; }
        .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s;
        }
        .toggle-icon.collapsed { transform: rotate(-90deg); }
        .panel-body {
            padding: 20px;
            display: block;
        }
        .panel-body.collapsed { display: none; }
        
        #videoElement {
            width: 100%;
            max-width: 800px;
            height: auto;
            background: #000;
            border-radius: 8px;
            display: block;
            margin: 0 auto;
        }
        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.connecting { background: #fff3cd; color: #856404; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 15px; }
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .control-group label { font-weight: 600; color: #333; }
        input[type="range"] { width: 100%; }
        select, button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 600;
            transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .position-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .position-table th, .position-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .position-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }
        .position-table tr:hover { background: #f1f3f5; }
        .position-table button {
            padding: 5px 10px;
            font-size: 0.9em;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        .toast.show { opacity: 1; }
        .toast.error { background: #dc3545; }
        .toast.success { background: #28a745; }
        
        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .button-row button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– è‡ªå‹•çµ„ç«‹ãƒ­ãƒœãƒƒãƒˆåˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p class="subtitle">WebRTCä½é…å»¶ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚° + IAI RCP2-GRSS ã‚°ãƒªãƒƒãƒ‘ãƒ¼åˆ¶å¾¡</p>
        </div>
        
        <div class="content">
            <!-- ã‚«ãƒ¡ãƒ©ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="panel">
                <div class="panel-header" onclick="togglePanel('camera')">
                    <h2>ğŸ“¹ ã‚«ãƒ¡ãƒ©æ˜ åƒ (WebRTC)</h2>
                    <span class="toggle-icon" id="camera-toggle">â–¼</span>
                </div>
                <div class="panel-body" id="camera-body">
                    <div id="connectionStatus" class="status connecting">æ¥ç¶šä¸­...</div>
                    <video id="videoElement" autoplay playsinline muted></video>
                    
                    <div class="controls">
                        <div class="control-group">
                            <label>è§£åƒåº¦:</label>
                            <select id="resolutionSelect" onchange="changeResolution()">
                                <option value="320x240">QVGA (320x240)</option>
                                <option value="640x480" selected>VGA (640x480)</option>
                                <option value="800x600">SVGA (800x600)</option>
                                <option value="1280x720">HD (1280x720)</option>
                                <option value="1920x1080">Full HD (1920x1080)</option>
                                <option value="2304x1536">High (2304x1536)</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯:</label>
                            <select id="codecSelect" onchange="changeCodec()">
                                <option value="MJPG" selected>MJPEG (æ¨å¥¨)</option>
                                <option value="YUYV">YUYV 4:2:2</option>
                            </select>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 20px; margin-bottom: 10px;">ã‚«ãƒ¡ãƒ©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h3>
                    <div class="button-row">
                        <button class="secondary" onclick="resetCameraDefaults()">ğŸ”„ ã™ã¹ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
                    </div>
                    <div id="cameraControls" class="controls"></div>
                </div>
            </div>
            
            <!-- ã‚°ãƒªãƒƒãƒ‘ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="panel">
                <div class="panel-header" onclick="togglePanel('gripper')">
                    <h2>ğŸ¤ ã‚°ãƒªãƒƒãƒ‘ãƒ¼åˆ¶å¾¡</h2>
                    <span class="toggle-icon" id="gripper-toggle">â–¼</span>
                </div>
                <div class="panel-body" id="gripper-body">
                    <div class="status connected">
                        <span id="gripperStatus">ä½ç½®: --mm | ã‚µãƒ¼ãƒœ: --</span>
                    </div>
                    
                    <div class="button-row">
                        <button onclick="gripperServo('on')">âš¡ ã‚µãƒ¼ãƒœON</button>
                        <button onclick="gripperServo('off')">â­• ã‚µãƒ¼ãƒœOFF</button>
                        <button onclick="gripperHome()">ğŸ  åŸç‚¹å¾©å¸°</button>
                    </div>
                    
                    <div class="control-group" style="margin-top: 15px;">
                        <label>ãƒã‚¸ã‚·ãƒ§ãƒ³ç§»å‹• (0-63):</label>
                        <input type="number" id="positionInput" min="0" max="63" value="0">
                        <button onclick="gripperMove()">â¡ï¸ ç§»å‹•</button>
                    </div>
                </div>
            </div>
            
            <!-- ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="panel">
                <div class="panel-header" onclick="togglePanel('positions')">
                    <h2>ğŸ“Š ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«</h2>
                    <span class="toggle-icon" id="positions-toggle">â–¼</span>
                </div>
                <div class="panel-body collapsed" id="positions-body">
                    <button onclick="loadPositions()">ğŸ”„ ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿</button>
                    <table class="position-table" id="positionTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>ç›®æ¨™ä½ç½® (mm)</th>
                                <th>ä½ç½®æ±ºã‚å¹… (mm)</th>
                                <th>é€Ÿåº¦ (mm/s)</th>
                                <th>åŠ é€Ÿåº¦ (G)</th>
                                <th>æ¸›é€Ÿåº¦ (G)</th>
                                <th>æŠ¼ä»˜é›»æµ (%)</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="positionTableBody">
                            <tr><td colspan="8" style="text-align: center;">ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>
    
    <script>
        let pc = null;
        let cameraDefaults = {};
        let currentCodec = 'MJPG';
        
        // Toasté€šçŸ¥
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // ãƒ‘ãƒãƒ«æŠ˜ã‚ŠãŸãŸã¿
        function togglePanel(panelId) {
            const body = document.getElementById(panelId + '-body');
            const icon = document.getElementById(panelId + '-toggle');
            body.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
        }
        
        // æ¥ç¶šçŠ¶æ…‹è¡¨ç¤º
        function updateConnectionStatus(status) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = 'status ' + status;
            const messages = {
                'connecting': 'ğŸ”„ æ¥ç¶šä¸­...',
                'connected': 'âœ… æ¥ç¶šå®Œäº†',
                'disconnected': 'âŒ åˆ‡æ–­'
            };
            statusDiv.textContent = messages[status] || status;
            console.log('WebRTCçŠ¶æ…‹æ›´æ–°:', status);
        }
        
        // WebRTCæ¥ç¶š
        async function setupWebRTC() {
            updateConnectionStatus('connecting');
            console.log('ğŸ”— WebRTCæ¥ç¶šé–‹å§‹...');
            
            try {
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                pc.ontrack = (event) => {
                    console.log('âœ… ãƒˆãƒ©ãƒƒã‚¯å—ä¿¡:', event.track.kind, event.streams.length);
                    const video = document.getElementById('videoElement');
                    video.srcObject = event.streams[0];
                    
                    // ãƒ“ãƒ‡ã‚ªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†æ™‚
                    video.onloadedmetadata = () => {
                        console.log('ğŸ“¹ ãƒ“ãƒ‡ã‚ªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', video.videoWidth, 'x', video.videoHeight);
                        updateConnectionStatus('connected');
                    };
                    
                    // å†ç”Ÿé–‹å§‹
                    video.play().catch(e => console.error('å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e));
                };
                
                pc.oniceconnectionstatechange = () => {
                    console.log('ğŸ§Š ICEæ¥ç¶šçŠ¶æ…‹:', pc.iceConnectionState);
                    if (pc.iceConnectionState === 'failed' || pc.iceConnectionState === 'disconnected') {
                        updateConnectionStatus('disconnected');
                    } else if (pc.iceConnectionState === 'connected') {
                        console.log('âœ… ICEæ¥ç¶šç¢ºç«‹');
                    }
                };
                
                pc.onconnectionstatechange = () => {
                    console.log('ğŸ”— æ¥ç¶šçŠ¶æ…‹:', pc.connectionState);
                };
                
                // Video transceiverã‚’è¿½åŠ 
                console.log('ğŸ“¡ Transceiverè¿½åŠ : video, recvonly');
                pc.addTransceiver("video", { direction: "recvonly" });
                
                // Offerã‚’ä½œæˆ
                console.log('ğŸ“ Offerä½œæˆä¸­...');
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                console.log('ğŸ“¤ Offerä½œæˆå®Œäº†:', offer.sdp.length, 'bytes');
                
                // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
                const response = await fetch('/api/webrtc/offer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sdp: pc.localDescription.sdp,
                        type: pc.localDescription.type,
                        width: 640,
                        height: 480
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('âŒ WebRTC Offer ã‚¨ãƒ©ãƒ¼:', errorData);
                    showToast('WebRTCæ¥ç¶šã‚¨ãƒ©ãƒ¼', 'error');
                    updateConnectionStatus('disconnected');
                    return;
                }
                
                const answer = await response.json();
                console.log('ğŸ“¥ Answerå—ä¿¡:', answer.sdp.length, 'bytes');
                await pc.setRemoteDescription(new RTCSessionDescription(answer));
                console.log('âœ… RemoteDescriptionè¨­å®šå®Œäº†');
                
            } catch (error) {
                console.error('âŒ WebRTCè¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                showToast('WebRTCæ¥ç¶šå¤±æ•—: ' + error.message, 'error');
                updateConnectionStatus('disconnected');
            }
        }
        
        // ã‚«ãƒ¡ãƒ©åˆ¶å¾¡èª­ã¿è¾¼ã¿
        async function loadCameraControls() {
            const response = await fetch('/api/camera/controls');
            const data = await response.json();
            
            if (data.status === 'ok') {
                const container = document.getElementById('cameraControls');
                container.innerHTML = '';
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä¿å­˜
                cameraDefaults = {};
                
                for (const [name, ctrl] of Object.entries(data.controls)) {
                    cameraDefaults[name] = ctrl.default;
                    
                    const group = document.createElement('div');
                    group.className = 'control-group';
                    
                    group.innerHTML = `
                        <label>${name}: <span id="${name}-value">${ctrl.value}</span></label>
                        <input type="range" 
                               id="${name}" 
                               min="${ctrl.min}" 
                               max="${ctrl.max}" 
                               value="${ctrl.value}"
                               oninput="updateCameraControl('${name}', this.value)">
                    `;
                    container.appendChild(group);
                }
            }
        }
        
        // ã‚«ãƒ¡ãƒ©åˆ¶å¾¡æ›´æ–°
        async function updateCameraControl(name, value) {
            document.getElementById(name + '-value').textContent = value;
            await fetch(`/api/camera/control/${name}/${value}`, { method: 'POST' });
        }
        
        // ã‚«ãƒ¡ãƒ©ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒªã‚»ãƒƒãƒˆ
        async function resetCameraDefaults() {
            for (const [name, defaultValue] of Object.entries(cameraDefaults)) {
                const slider = document.getElementById(name);
                if (slider && defaultValue !== null) {
                    slider.value = defaultValue;
                    await updateCameraControl(name, defaultValue);
                }
            }
            showToast('ã‚«ãƒ¡ãƒ©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ', 'success');
        }
        
        // ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯å¤‰æ›´
        async function changeCodec() {
            const codec = document.getElementById('codecSelect').value;
            currentCodec = codec;
            
            // v4l2-ctlçµŒç”±ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›´ï¼ˆå®Ÿè£…ãŒå¿…è¦ãªå ´åˆï¼‰
            // ç¾çŠ¶ã¯ã‚«ãƒ¡ãƒ©å†æ¥ç¶šæ™‚ã«åæ˜ ã•ã‚Œã‚‹æƒ³å®š
            showToast(`ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯ã‚’${codec}ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');
        }
        
        // è§£åƒåº¦å¤‰æ›´
        async function changeResolution() {
            const resolution = document.getElementById('resolutionSelect').value;
            const [width, height] = resolution.split('x').map(Number);
            
            const response = await fetch('/api/camera/resolution', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ width, height })
            });
            
            const data = await response.json();
            if (data.status === 'ok') {
                showToast(data.message, 'success');
                // WebRTCå†æ¥ç¶š
                if (pc) {
                    pc.close();
                }
                setTimeout(setupWebRTC, 1000);
            }
        }
        
        // ã‚°ãƒªãƒƒãƒ‘ãƒ¼çŠ¶æ…‹æ›´æ–°
        async function updateGripperStatus() {
            const response = await fetch('/api/gripper/status');
            const data = await response.json();
            
            if (data.status === 'ok') {
                document.getElementById('gripperStatus').textContent = 
                    `ä½ç½®: ${data.position_mm.toFixed(2)}mm | ã‚µãƒ¼ãƒœ: ${data.servo_on ? 'ON' : 'OFF'}`;
            }
        }
        
        // ã‚°ãƒªãƒƒãƒ‘ãƒ¼åˆ¶å¾¡
        async function gripperServo(action) {
            await fetch(`/api/gripper/servo/${action}`, { method: 'POST' });
            updateGripperStatus();
        }
        
        async function gripperHome() {
            await fetch('/api/gripper/home', { method: 'POST' });
            updateGripperStatus();
        }
        
        async function gripperMove() {
            const position = document.getElementById('positionInput').value;
            await fetch(`/api/gripper/move/${position}`, { method: 'POST' });
            updateGripperStatus();
        }
        
        // ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿
        async function loadPositions() {
            const response = await fetch('/api/gripper/positions');
            const data = await response.json();
            
            if (data.status === 'ok') {
                const tbody = document.getElementById('positionTableBody');
                tbody.innerHTML = '';
                
                for (let i = 0; i < 64; i++) {
                    const pos = data.positions[i];
                    if (pos && !pos.error) {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${i}</td>
                            <td>${pos.position_mm.toFixed(2)}</td>
                            <td>${pos.width_mm.toFixed(2)}</td>
                            <td>${pos.speed_mm_s.toFixed(2)}</td>
                            <td>${pos.accel_g.toFixed(2)}</td>
                            <td>${pos.decel_g.toFixed(2)}</td>
                            <td>${pos.push_current_percent}</td>
                            <td><button onclick="editPosition(${i})">ç·¨é›†</button></td>
                        `;
                    }
                }
                showToast('ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿å®Œäº†', 'success');
            }
        }
        
        function editPosition(posNum) {
            showToast('ç·¨é›†æ©Ÿèƒ½ã¯æœªå®Ÿè£…ã§ã™', 'info');
        }
        
        // åˆæœŸåŒ–
        window.onload = () => {
            setupWebRTC();
            loadCameraControls();
            setInterval(updateGripperStatus, 2000);
        };
    </script>
</body>
</html>
