<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëá™ÂãïÁµÑÁ´ã„É≠„Éú„ÉÉ„ÉàÂà∂Âæ° v2.1</title>
        <link rel="stylesheet" href="/static/css/style.css?v=1762693000">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="header">
        <h1>ü§ñ Ëá™ÂãïÁµÑÁ´ã„É≠„Éú„ÉÉ„ÉàÂà∂Âæ°„Ç∑„Çπ„ÉÜ„É† v2.1</h1>
    </div>
    
    <div class="main-container">
        <div class="column video-column">
            <div class="video-container">
                <div class="video-wrapper">
                    <div id="connectionStatus" class="status connecting">Êé•Á∂ö‰∏≠...</div>
                    <div id="cameraRemoteStatus" class="status connecting">üì° „Ç´„É°„É©Pi: --</div>
                    <video id="videoElement" autoplay playsinline muted></video>
                    <div id="crosshairOverlay" class="crosshair-overlay hidden" aria-hidden="true">
                        <div class="crosshair-line horizontal"></div>
                        <div class="crosshair-line vertical"></div>
                        <div class="crosshair-dot"></div>
                    </div>
                </div>
                <div class="video-controls">
                    <button class="success" onclick="takeSnapshot()">üì∏ „Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà</button>
                    <button type="button" class="secondary" onclick="toggleCrosshair()">üéØ ÁÖßÊ∫ñ</button>
                    <button onclick="detectFiber()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">üìè Fiber</button>
                    <button onclick="detectBead()" style="background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);">üîµ Bead</button>
                    <select id="resolutionSelect" onchange="changeResolution()">
                        <option value="320x240">QVGA (320x240)</option>
                        <option value="640x480" selected>VGA (640x480)</option>
                        <option value="800x600">SVGA (800x600)</option>
                        <option value="1280x720">HD (1280x720)</option>
                        <option value="1920x1080">Full HD (1920x1080)</option>
                    </select>
                    <select id="codecSelect" onchange="changeCodec()">
                        <option value="MJPG" selected>MJPEG</option>
                        <option value="YUYV">YUYV</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="column monitor-column">
            <div class="panel">
                <div class="panel-header static">
                    <h2>üìä „É¢„Éã„Çø„Éº</h2>
                </div>
                <div class="panel-body">
                    <div class="monitor-switch">
                        <button type="button" id="monitorToggleButton" onclick="toggleMonitorView(event)">‚ö° ÈõªÊµÅÂÄ§„É¢„Éã„Çø„Éº„Å´ÂàáÊõø</button>
                    </div>
                    <div id="gripMonitorView" class="monitor-view active">

                        <div class="grip-status-display">
                            <div class="grip-indicator" id="gripIndicator">
                                <div class="status-led" id="statusLed"></div>
                                <div class="status-text" id="statusText">ÂæÖÊ©ü‰∏≠</div>
                            </div>
                            <div class="grip-details">
                                <div class="detail-item">
                                    <span class="detail-label">ÈõªÊµÅÂÄ§:</span>
                                    <span class="detail-value" id="gripCurrent">--</span> mA
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">‰ΩçÁΩÆ:</span>
                                    <span class="detail-value" id="gripPosition">--</span> mm
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Á©∫ÊåØ„Çä„Éï„É©„Ç∞:</span>
                                    <span class="detail-value" id="gripPsfl">--</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Âà§ÂÆöÁêÜÁî±:</span>
                                    <span class="detail-value" id="gripReason">--</span>
                                </div>
                            </div>
                            <div class="monitor-actions">
                                <button type="button" class="secondary" onclick="fetchGripStatus()">üîÑ Áä∂ÊÖãÂèñÂæó</button>
                            </div>
                        </div>
                    </div>

                    <div id="currentMonitorView" class="monitor-view">
                        <div class="current-display">
                            <div class="current-value-large">
                                <span id="currentValue">--</span> <span class="unit">mA</span>
                            </div>
                        </div>
                        <canvas id="currentChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header static">
                    <h2>üñ®Ô∏è 3D„Éó„É™„É≥„Çø„Éº</h2>
                </div>
                <div class="panel-body printer-panel">
                    <div id="printerStatusMessage" class="printer-status-message">OctoPrintË®≠ÂÆö„ÇíË°å„ÅÜ„Å®ÊÉÖÂ†±„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</div>
                    <div class="printer-state-row">
                        <div class="printer-state-card">
                            <div class="label">Áä∂ÊÖã</div>
                            <div class="value" id="printerState">--</div>
                        </div>
                        <div class="printer-eta">
                            <div class="label">ÂÆå‰∫Ü‰∫àÊ∏¨</div>
                            <div class="value" id="printerEta">--</div>
                        </div>
                    </div>
                    <div class="printer-progress">
                        <div class="progress-heading">
                            <span>ÈÄ≤Êçó</span>
                            <span id="printerProgressText">--%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="printerProgressBar"></div>
                        </div>
                    </div>
                    <div class="printer-temps">
                        <div class="temp-card">
                            <div class="temp-label">„Éé„Ç∫„É´</div>
                            <div class="temp-value" id="printerToolTemp">-- ‚ÑÉ</div>
                        </div>
                        <div class="temp-card">
                            <div class="temp-label">„Éô„ÉÉ„Éâ</div>
                            <div class="temp-value" id="printerBedTemp">-- ‚ÑÉ</div>
                        </div>
                    </div>
                    <div class="printer-actions">
                        <button type="button" class="secondary" id="pausePrinterButton" onclick="pausePrinterJob()" disabled>‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢</button>
                        <button type="button" class="secondary" id="resumePrinterButton" onclick="resumePrinterJob()" disabled>‚ñ∂Ô∏è ÂÜçÈñã</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="column control-column">
            <div class="panel">
                <div class="panel-header" onclick="togglePanel('params')">
                    <h2>üéöÔ∏è „Ç´„É°„É©„Éë„É©„É°„Éº„Çø</h2>
                    <span class="toggle-icon" id="params-toggle">‚ñº</span>
                </div>
                <div class="panel-body" id="params-body">
                    <button class="secondary" onclick="resetCameraDefaults()" style="width: 100%; margin-bottom: 10px;">üîÑ „Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô</button>
                    <div id="cameraControls" class="controls"></div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header" onclick="togglePanel('snapshots')">
                    <h2>üì∑ „Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà</h2>
                    <span class="toggle-icon collapsed" id="snapshots-toggle">‚ñº</span>
                </div>
                <div class="panel-body collapsed" id="snapshots-body">
                    <button onclick="loadSnapshots()" style="width: 100%; margin-bottom: 10px;">üîÑ ‰∏ÄË¶ßÊõ¥Êñ∞</button>
                    <div id="snapshotsGrid" class="snapshots-grid"></div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header" onclick="togglePanel('gripper')">
                    <h2>ü§è „Ç∞„É™„ÉÉ„Éë„ÉºÂà∂Âæ°</h2>
                    <span class="toggle-icon collapsed" id="gripper-toggle">‚ñº</span>
                </div>
                <div class="panel-body collapsed" id="gripper-body">
                    <div class="button-row" style="margin-bottom: 10px;">
                        <button onclick="gripperServo('on')">‚ö° „Çµ„Éº„ÉúON</button>
                        <button onclick="gripperServo('off')">‚≠ï „Çµ„Éº„ÉúOFF</button>
                    </div>
                    <button onclick="gripperHome()" style="width: 100%; margin-bottom: 10px;">üè† ÂéüÁÇπÂæ©Â∏∞</button>

                    <div class="control-group">
                        <label>„Éù„Ç∏„Ç∑„Éß„É≥ÁßªÂãï (0-63):</label>
                        <input type="number" id="positionInput" min="0" max="63" value="0">
                        <button onclick="gripperMove()">‚û°Ô∏è ÁßªÂãï</button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header" onclick="togglePanel('robot')">
                    <h2>üß≠ SPLEBO-N Âà∂Âæ°</h2>
                    <span class="toggle-icon collapsed" id="robot-toggle">‚ñº</span>
                </div>
                <div class="panel-body collapsed" id="robot-body">
                    <div class="control-group">
                        <label>ÁèæÂú®‰ΩçÁΩÆ (mm):</label>
                        <div class="button-row" style="margin-bottom: 5px;">
                            <div style="width: 32%;">X: <span id="robotPosX">--</span></div>
                            <div style="width: 32%;">Y: <span id="robotPosY">--</span></div>
                            <div style="width: 32%;">Z: <span id="robotPosZ">--</span></div>
                        </div>
                    </div>

                    <div class="button-row" style="margin-bottom: 10px;">
                        <button class="success" onclick="robotHome()">üè† ÂéüÁÇπÂæ©Â∏∞</button>
                        <button class="danger" onclick="robotStopAll()">‚õî ÂÅúÊ≠¢</button>
                    </div>

                    <div class="control-group">
                        <label>JOGÈÄüÂ∫¶ (mm/s):</label>
                        <input type="number" id="robotJogSpeed" step="0.1" value="10">
                    </div>
                    <div class="control-group">
                        <label>JOGËª∏:</label>
                        <select id="robotJogAxis">
                            <option value="0">X</option>
                            <option value="1">Y</option>
                            <option value="2">Z</option>
                        </select>
                    </div>
                    <div class="button-row" style="margin-bottom: 10px;">
                        <button id="robotJogNegative" class="secondary">‚óÄ JOG -</button>
                        <button id="robotJogPositive" class="secondary">JOG + ‚ñ∂</button>
                    </div>

                    <div class="control-group">
                        <label>ÁôªÈå≤„Éù„Ç§„É≥„ÉàÁï™Âè∑:</label>
                        <input type="number" id="robotRegisterPointNo" min="0" value="1">
                    </div>
                    <div class="control-group">
                        <label>ÁôªÈå≤„Éù„Ç§„É≥„ÉàÂ∫ßÊ®ô (mm):</label>
                        <div class="button-row" style="margin-bottom: 5px;">
                            <div style="width: 32%;">X: <span id="robotRegisterPointX">--</span></div>
                            <div style="width: 32%;">Y: <span id="robotRegisterPointY">--</span></div>
                            <div style="width: 32%;">Z: <span id="robotRegisterPointZ">--</span></div>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>„Ç≥„É°„É≥„Éà:</label>
                        <input type="text" id="robotPointComment" placeholder="comment">
                    </div>
                    <button onclick="registerRobotPoint()" style="width: 100%; margin-bottom: 10px;">üíæ ÁèæÂú®‰ΩçÁΩÆ„ÇíÁôªÈå≤</button>

                    <div class="control-group">
                        <label>ÁßªÂãï„Éù„Ç§„É≥„ÉàÁï™Âè∑:</label>
                        <input type="number" id="robotMovePointNo" min="0" value="1">
                    </div>
                    <div class="control-group">
                        <label>ÁßªÂãï„Éù„Ç§„É≥„ÉàÂ∫ßÊ®ô (mm):</label>
                        <div class="button-row" style="margin-bottom: 5px;">
                            <div style="width: 32%;">X: <span id="robotMovePointX">--</span></div>
                            <div style="width: 32%;">Y: <span id="robotMovePointY">--</span></div>
                            <div style="width: 32%;">Z: <span id="robotMovePointZ">--</span></div>
                        </div>
                    </div>
                    <button onclick="moveRobotPoint()" style="width: 100%; margin-bottom: 10px;">üéØ „Éù„Ç§„É≥„Éà„Å∏ÁßªÂãï</button>

                    <div class="control-group">
                        <label>IOÂá∫Âäõ (CAN):</label>
                        <div class="io-grid">
                            <div class="io-card">
                                <div class="io-card-title">ÊâãÂãï IO</div>
                                <div class="button-row" style="margin-bottom: 6px;">
                                    <input type="number" id="robotIoBoard" min="0" max="15" value="1" placeholder="ID" style="width: 48%;">
                                    <input type="number" id="robotIoPort" min="0" max="31" value="0" placeholder="Port" style="width: 48%;">
                                </div>
                                <div class="io-card-note">ÁèæÂú®Áä∂ÊÖã: <span id="robotIoStatus">--</span></div>
                                <div class="button-row tight">
                                    <button class="success" onclick="manualRobotIoOutput(true)">ON</button>
                                    <button class="secondary" onclick="manualRobotIoOutput(false)">OFF</button>
                                </div>
                            </div>
                            <div class="io-card">
                                <div class="io-card-title">„Éá„Ç£„Çπ„Éö„É≥„Çπ</div>
                                <button class="success" onclick="triggerDispense()">üíß „Éá„Ç£„Çπ„Éö„É≥„Çπ</button>
                                <div class="io-card-note">ID1 / Port0 / 0.1s</div>
                            </div>

                            <div class="io-card">
                                <div class="io-card-title">EC1</div>
                                <div class="button-row tight">
                                    <button onclick="triggerEcPulse(1, 'up')">‚¨Ü UP</button>
                                    <button class="secondary" onclick="triggerEcPulse(1, 'down')">‚¨á DOWN</button>
                                </div>
                                <div class="io-card-note">UP: ID2 Port16 / DOWN: Port17ÔºàÊéí‰ªñONÔºâ</div>
                            </div>

                            <div class="io-card">
                                <div class="io-card-title">EC2</div>
                                <div class="button-row tight">
                                    <button onclick="triggerEcPulse(2, 'up')">‚¨Ü UP</button>
                                    <button class="secondary" onclick="triggerEcPulse(2, 'down')">‚¨á DOWN</button>
                                </div>
                                <div class="io-card-note">UP: ID2 Port20 / DOWN: Port21ÔºàÊéí‰ªñONÔºâ</div>
                            </div>

                            <div class="io-card">
                                <div class="io-card-title">EC3</div>
                                <div class="button-row tight">
                                    <button onclick="triggerEcPulse(3, 'up')">‚¨Ü UP</button>
                                    <button class="secondary" onclick="triggerEcPulse(3, 'down')">‚¨á DOWN</button>
                                </div>
                                <div class="io-card-note">UP: ID2 Port24 / DOWN: Port25ÔºàÊéí‰ªñONÔºâ</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header" onclick="togglePanel('postable')">
                    <h2>üìã „Éù„Ç∏„Ç∑„Éß„É≥„ÉÜ„Éº„Éñ„É´</h2>
                    <span class="toggle-icon collapsed" id="postable-toggle">‚ñº</span>
                </div>
                <div class="panel-body collapsed" id="postable-body">
                    <div class="button-row" style="margin-bottom: 10px;">
                        <button onclick="loadAllPositions()">üì• ÂÖ®‰ª∂Ë™≠Ëæº</button>
                        <button onclick="toggleTableView()">üîÑ Ë°®Á§∫ÂàáÊõø</button>
                    </div>

                    <div id="posTableList" style="display:none;">
                        <div class="postable-container">
                            <table class="postable-table">
                                <thead>
                                    <tr>
                                        <th>Pos</th>
                                        <th>‰ΩçÁΩÆ<br>(mm)</th>
                                        <th>ÂπÖ<br>(mm)</th>
                                        <th>ÈÄüÂ∫¶<br>(mm/s)</th>
                                        <th>Âä†ÈÄü<br>(G)</th>
                                        <th>Ê∏õÈÄü<br>(G)</th>
                                        <th>ÊäºÂΩì<br>(%)</th>
                                    </tr>
                                </thead>
                                <tbody id="posTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="pagination"></div>
                    </div>

                    <div id="posTableEdit">
                        <div class="control-group" style="margin-bottom: 10px;">
                            <label>„Éù„Ç∏„Ç∑„Éß„É≥Áï™Âè∑ (0-63):</label>
                            <input type="number" id="posTableSelect" min="0" max="63" value="0">
                            <button onclick="loadPositionTable()">ÔøΩÔøΩ Ë™≠„ÅøËæº„Åø</button>
                        </div>

                        <div id="posTableData" class="controls" style="display:none; margin-top: 10px; position: relative; z-index: 50;">
                            <div class="control-group">
                                <label>ÁõÆÊ®ô‰ΩçÁΩÆ (mm):</label>
                                <input type="number" id="pt_position_mm" min="0" max="4" step="0.01" value="0">
                            </div>
                            <div class="control-group">
                                <label>‰ΩçÁΩÆÊ±∫„ÇÅÂπÖ (mm):</label>
                                <input type="number" id="pt_width_mm" min="0" max="4" step="0.01" value="0.1">
                            </div>
                            <div class="control-group">
                                <label>ÈÄüÂ∫¶ (mm/s):</label>
                                <input type="number" id="pt_speed_mm_s" min="2" max="78" step="0.1" value="50">
                            </div>
                            <div class="control-group">
                                <label>Âä†ÈÄüÂ∫¶ (G):</label>
                                <input type="number" id="pt_accel_g" min="0.01" max="0.3" step="0.01" value="0.3">
                            </div>
                            <div class="control-group">
                                <label>Ê∏õÈÄüÂ∫¶ (G):</label>
                                <input type="number" id="pt_decel_g" min="0.01" max="0.3" step="0.01" value="0.3">
                            </div>
                            <div class="control-group">
                                <label>Êäº‰ªò„ÅëÈõªÊµÅ (%):</label>
                                <input type="number" id="pt_push_current" min="0" max="70" value="0">
                            </div>
                            <button onclick="savePositionTable()" style="width: 100%; margin-top: 5px; position: relative; z-index: 100; cursor: pointer; pointer-events: auto;">üíæ ‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header" onclick="togglePanel('robotpostable')">
                    <h2>üìç „É≠„Éú„ÉÉ„Éà „Éù„Ç∏„Ç∑„Éß„É≥„ÉÜ„Éº„Éñ„É´</h2>
                    <span class="toggle-icon collapsed" id="robotpostable-toggle">‚ñº</span>
                </div>
                <div class="panel-body collapsed" id="robotpostable-body">
                    <div class="button-row" style="margin-bottom: 10px;">
                        <button onclick="loadAllRobotPositions()">üì• ÂÖ®‰ª∂Ë™≠Ëæº</button>
                        <button onclick="toggleRobotTableView()">üîÑ Ë°®Á§∫ÂàáÊõø</button>
                    </div>

                    <div id="robotPosTableList" style="display:none;">
                        <div class="postable-container">
                            <table class="postable-table">
                                <thead>
                                    <tr>
                                        <th>Point</th>
                                        <th>X (mm)</th>
                                        <th>Y (mm)</th>
                                        <th>Z (mm)</th>
                                        <th>Comment</th>
                                    </tr>
                                </thead>
                                <tbody id="robotPosTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="robotPosPagination"></div>
                    </div>

                    <div id="robotPosTableEdit">
                        <div class="control-group">
                            <label>„Éù„Ç§„É≥„ÉàÁï™Âè∑:</label>
                            <input type="number" id="robotPosTableSelect" min="0" value="1">
                            <button onclick="loadRobotPositionTable()">üì• Ë™≠Ëæº</button>
                        </div>

                        <div class="control-group">
                            <label>X (mm):</label>
                            <input type="number" id="robot_pt_x" step="0.01" value="0">
                        </div>
                        <div class="control-group">
                            <label>Y (mm):</label>
                            <input type="number" id="robot_pt_y" step="0.01" value="0">
                        </div>
                        <div class="control-group">
                            <label>Z (mm):</label>
                            <input type="number" id="robot_pt_z" step="0.01" value="0">
                        </div>
                        <div class="control-group">
                            <label>„Ç≥„É°„É≥„Éà:</label>
                            <input type="text" id="robot_pt_comment" placeholder="comment">
                        </div>
                        <button onclick="saveRobotPositionTable()" style="width: 100%; margin-bottom: 10px;">üíæ ‰øùÂ≠ò</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
        <!-- Âõ∫ÂÆö„Ç∞„É™„ÉÉ„Éë„Éº„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫ -->
    <div id="gripperStatusFixed" class="gripper-status-fixed">
        <div class="status-label">ü§è „Ç∞„É™„ÉÉ„Éë„Éº</div>
        <span id="gripperStatus">‰ΩçÁΩÆ: --mm | „Çµ„Éº„Éú: --</span>
    </div>
    
    <div id="toast" class="toast"></div>
    <!-- Vision Result Modal -->
    <div id="visionModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center;">
        <div class="modal-content" style="background: #16213e; padding: 20px; border-radius: 10px; border: 2px solid #00d4ff; max-width: 90%; max-height: 90%; overflow: auto; text-align: center; position: relative;">
            <span class="close" onclick="document.getElementById('visionModal').style.display='none'" style="position: absolute; top: 10px; right: 15px; color: #fff; font-size: 24px; cursor: pointer;">&times;</span>
            <h3 style="color: #00d4ff; margin-bottom: 15px;">Detection Result</h3>
            <img id="visionResultImage" style="max-width: 100%; max-height: 60vh; border: 1px solid #555; margin-bottom: 15px;">
            <div id="visionResultData" style="color: #fff; text-align: left; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;"></div>
        </div>
    </div>
    
        <script src="/static/js/app.js?v=1762693000"></script>
</body>
</html>
